<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ArcGIS Map in Joget</title>
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>
  <style>
    html, body, #viewDiv { height: 100%; margin: 0; padding: 0; }
    #sketchDiv {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 99;
      background: white;
      padding: 10px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <input type="hidden" name="sketchData" id="sketchData" />
  <div id="viewDiv"></div>
  <div id="sketchDiv"></div>

 <script>
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/widgets/Sketch",
  "esri/layers/GraphicsLayer"
], function(Map, MapView, Sketch, GraphicsLayer) {

  const graphicsLayer = new GraphicsLayer();

  const map = new Map({
    basemap: "topo-vector",
    layers: [graphicsLayer]
  });

  const view = new MapView({
    container: "viewDiv",
    map: map,
    center: [31.8, 30.4],
    zoom: 8
  });

  const sketch = new Sketch({
    layer: graphicsLayer,
    view: view,
    creationMode: "update",
    availableCreateTools: ["point", "polyline", "polygon", "rectangle", "circle"],
    container: "sketchDiv"
  });

  // When a graphic is added or updated, send all graphics to parent
  function sendSketchData() {
    const graphicsJSON = graphicsLayer.graphics.toArray().map(g => g.toJSON());
    window.parent.postMessage({
      type: "sketchSaved",
      data: JSON.stringify(graphicsJSON)
    }, "*");
  }

  sketch.on("create", e => { if (e.state === "complete") sendSketchData(); });
  sketch.on("update", e => { if (e.state === "complete") sendSketchData(); });

  // Listen for parent sending back saved sketch
  window.addEventListener("message", e => {
    if (e.data.type === "loadSketch" && e.data.data) {
      const savedGraphics = JSON.parse(e.data.data);
      savedGraphics.forEach(gJSON => {
        graphicsLayer.add(gJSON);
      });
    }
  });
});
</script>

</body>
</html>

